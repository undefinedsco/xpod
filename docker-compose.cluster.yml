# Xpod 集群测试环境 - IdP/SP 分离架构
#
# 启动: COMPOSE_FILE=docker-compose.cluster.yml docker compose up --build -d
# 停止: COMPOSE_FILE=docker-compose.cluster.yml docker compose down
#
# 架构:
#   - postgres: PostgreSQL 数据库
#   - redis: Redis 缓存/锁
#   - minio: MinIO 对象存储
#   - cloud: Cloud 节点 (6300) - IdP + API Server + Pod 存储
#   - local: Local 节点 (5737) - 托管式，使用 Cloud IdP，SQLite 存储
#   - standalone: Standalone 节点 (5739) - 自带 IdP，SQLite 存储
#
# 测试覆盖:
#   ✅ 统一 Docker 测试: XPOD_RUN_INTEGRATION_TESTS=true yarn test:docker
#     包含以下场景的测试:
#     - Cloud 模式 (6300): PostgreSQL + MinIO + IdP + API Server
#     - Local 模式 (5737): SQLite 存储，使用 Cloud IdP
#     - Standalone 模式 (5739): SQLite 存储，自带 IdP
#
# 快速开始:
#   1. 启动集群: COMPOSE_FILE=docker-compose.cluster.yml docker compose up -d
#   2. 运行测试: yarn test:docker
#   3. 停止集群: docker compose down

x-xpod-image: &xpod-image
  image: xpod:dev
  build:
    context: .
    dockerfile: Dockerfile

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: xpod
      POSTGRES_PASSWORD: xpod
      POSTGRES_DB: xpod
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-postgres.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U xpod"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Cloud 节点 - 提供 IdP + API Server + Pod 存储
  cloud:
    <<: *xpod-image
    environment:
      NODE_ENV: development
      XPOD_EDITION: cloud
      XPOD_NODE_ID: cloud-a
      XPOD_EDGE_NODES_ENABLED: "false"
      XPOD_SUBDOMAIN_ENABLED: "false"
      XPOD_DDNS_DOMAIN: undefineds.xyz
      XPOD_ENCRYPTION_KEY: dev-encryption-key-change-in-production
      API_PORT: "6301"
      API_HOST: "0.0.0.0"
      CSS_PORT: "6300"
      CSS_BASE_URL: http://localhost:${CLOUD_PORT:-6300}
      CSS_LOGGING_LEVEL: info
      CSS_ALLOWED_HOSTS: "localhost,host.docker.internal"
      CSS_SPARQL_ENDPOINT: postgres://xpod:xpod@postgres:5432/xpod
      CSS_IDENTITY_DB_URL: postgres://xpod:xpod@postgres:5432/xpod
      CSS_IDENTITY_TABLE_PREFIX: "identity_account_"
      CSS_REDIS_CLIENT: redis:6379
      CSS_REDIS_USERNAME: ""
      CSS_REDIS_PASSWORD: ""
      CSS_MINIO_ENDPOINT: http://minio:9000
      CSS_MINIO_ACCESS_KEY: minioadmin
      CSS_MINIO_SECRET_KEY: minioadmin
      CSS_MINIO_BUCKET_NAME: xpod
      CSS_EMAIL_CONFIG_HOST: ""
      CSS_EMAIL_CONFIG_PORT: "587"
      CSS_EMAIL_CONFIG_AUTH_USER: ""
      CSS_EMAIL_CONFIG_AUTH_PASS: ""
      CSS_SEED_CONFIG: /app/config/seed.dev.json
    ports:
      - "${CLOUD_PORT:-6300}:6300"
    volumes:
      - cloud_data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-s", "-o", "/dev/null", "-w", "%{http_code}", "http://localhost:6300/service/status"]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 60s
    command: ["sh", "-c", "node dist/main.js -m cloud -p 6300 --host 0.0.0.0"]

  # Cloud_B 节点 - 第二个中心（与 Cloud 共享 postgres/redis/minio）
  #
  # 端口规划：
  #   - cloud    : 6300/6301
  #   - cloud_b  : 6400/6401
  #
  # 用于 MultiNodeCluster.integration.test.ts 的「双中心」集成测试。
  cloud_b:
    <<: *xpod-image
    environment:
      NODE_ENV: development
      XPOD_EDITION: cloud
      XPOD_NODE_ID: cloud-b
      XPOD_EDGE_NODES_ENABLED: "false"
      XPOD_SUBDOMAIN_ENABLED: "false"
      XPOD_DDNS_DOMAIN: undefineds.xyz
      XPOD_ENCRYPTION_KEY: dev-encryption-key-change-in-production
      API_PORT: "6401"
      API_HOST: "0.0.0.0"
      CSS_PORT: "6400"
      CSS_BASE_URL: http://localhost:${CLOUD_B_PORT:-6400}
      CSS_LOGGING_LEVEL: info
      CSS_ALLOWED_HOSTS: "localhost,host.docker.internal"
      CSS_SPARQL_ENDPOINT: postgres://xpod:xpod@postgres:5432/xpod
      CSS_IDENTITY_DB_URL: postgres://xpod:xpod@postgres:5432/xpod
      CSS_IDENTITY_TABLE_PREFIX: "identity_account_"
      CSS_REDIS_CLIENT: redis:6379
      CSS_REDIS_USERNAME: ""
      CSS_REDIS_PASSWORD: ""
      CSS_MINIO_ENDPOINT: http://minio:9000
      CSS_MINIO_ACCESS_KEY: minioadmin
      CSS_MINIO_SECRET_KEY: minioadmin
      CSS_MINIO_BUCKET_NAME: xpod
      CSS_EMAIL_CONFIG_HOST: ""
      CSS_EMAIL_CONFIG_PORT: "587"
      CSS_EMAIL_CONFIG_AUTH_USER: ""
      CSS_EMAIL_CONFIG_AUTH_PASS: ""
      CSS_SEED_CONFIG: /app/config/seed.dev.json
    ports:
      - "${CLOUD_B_PORT:-6400}:6400"
    volumes:
      - cloud_b_data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-s", "-o", "/dev/null", "-w", "%{http_code}", "http://localhost:6400/service/status"]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 60s
    command: ["sh", "-c", "node dist/main.js -m cloud -p 6400 --host 0.0.0.0"]

  # Local 模式 - 托管式，使用 Cloud IdP，SQLite 存储
  local:
    <<: *xpod-image
    environment:
      NODE_ENV: development
      XPOD_EDITION: local
      XPOD_NODE_ID: local-managed-node
      XPOD_ENCRYPTION_KEY: dev-encryption-key-change-in-production
      API_PORT: "5738"
      API_HOST: "0.0.0.0"
      CSS_PORT: "5737"
      CSS_BASE_URL: http://localhost:${LOCAL_PORT:-5737}
      CSS_IDP_URL: http://cloud:6300
      CSS_LOGGING_LEVEL: info
      CSS_SPARQL_ENDPOINT: sqlite:/app/data/local-managed.sqlite
      CSS_IDENTITY_DB_URL: sqlite:/app/data/local-managed-identity.sqlite
      CSS_SEED_CONFIG: /app/config/seed.dev.json
      http_proxy: ""
      https_proxy: ""
      HTTP_PROXY: ""
      HTTPS_PROXY: ""
    ports:
      - "${LOCAL_PORT:-5737}:5737"
    volumes:
      - local_data:/app/data
    depends_on:
      cloud:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-s", "-o", "/dev/null", "-w", "%{http_code}", "http://localhost:5737/service/status"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    command: ["sh", "-c", "node dist/main.js -m local -p 5737 --host 0.0.0.0"]

  # Standalone 模式 - 自带 IdP，不连接 Cloud
  standalone:
    <<: *xpod-image
    environment:
      NODE_ENV: development
      XPOD_EDITION: local
      # Standalone 模式：使用标准 local.json（自带 IdP）
      XPOD_ENCRYPTION_KEY: dev-encryption-key-change-in-production
      API_PORT: "5740"
      API_HOST: "0.0.0.0"
      CSS_PORT: "5739"
      CSS_BASE_URL: http://localhost:${STANDALONE_PORT:-5739}
      CSS_ALLOWED_HOSTS: "localhost,host.docker.internal"
      CSS_LOGGING_LEVEL: info
      CSS_SPARQL_ENDPOINT: sqlite:/app/data/local-standalone.sqlite
      CSS_IDENTITY_DB_URL: sqlite:/app/data/local-standalone-identity.sqlite
      CSS_SEED_CONFIG: /app/config/seed.dev.json
      http_proxy: ""
      https_proxy: ""
      HTTP_PROXY: ""
      HTTPS_PROXY: ""
    ports:
      - "${STANDALONE_PORT:-5739}:5739"
    volumes:
      - standalone_data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-s", "-o", "/dev/null", "-w", "%{http_code}", "http://localhost:5739/service/status"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    command: ["sh", "-c", "node dist/main.js -m local -p 5739 --host 0.0.0.0"]

volumes:
  postgres_data:
  redis_data:
  minio_data:
  cloud_data:
  cloud_b_data:
  local_data:
  standalone_data:
