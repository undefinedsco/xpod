{
  "@context": [
    "https://linkedsoftwaredependencies.org/bundles/npm/@solid/community-server/^8.0.0/components/context.jsonld",
    "https://linkedsoftwaredependencies.org/bundles/npm/@undefineds.co/xpod/^0.0.0/components/context.jsonld",
    "https://linkedsoftwaredependencies.org/bundles/npm/asynchronous-handlers/^1.0.0/components/context.jsonld"
  ],
  "import": [
    "./main.json",
    "./xpod.base.json",
    "./terminal.json"
  ],
  "@graph": [
    {
      "comment": "Xpod 统一配置 - 通过环境变量切换 Cloud/SP 模式",
      "@id": "urn:undefineds:xpod:Config",
      "@type": "Void"
    },
    {
      "comment": "定义 idpUrl 变量（外部 IdP 基础 URL）- SP 模式必填",
      "@id": "urn:solid-server:default:variable:idpUrl",
      "@type": "Variable"
    },
    {
      "comment": "MultiDomainIdentifierStrategy - 支持多域名（Cloud 模式）",
      "@id": "urn:undefineds:xpod:MultiDomainIdentifierStrategy",
      "@type": "MultiDomainIdentifierStrategy",
      "primaryBaseUrl": {
        "@id": "urn:solid-server:default:variable:baseUrl"
      },
      "additionalBaseUrls": [
        {
          "@id": "urn:solid-server:default:variable:idpUrl"
        }
      ]
    },
    {
      "comment": "SingleRootIdentifierStrategy - 单域名（SP 模式）",
      "@id": "urn:undefineds:xpod:SingleRootIdentifierStrategy",
      "@type": "SingleRootIdentifierStrategy",
      "baseUrl": {
        "@id": "urn:solid-server:default:variable:baseUrl"
      }
    },
    {
      "comment": "Override: 使用 MultiDomainIdentifierStrategy 替换默认策略（用于 Cloud 模式）",
      "@type": "Override",
      "overrideInstance": {
        "@id": "urn:solid-server:default:IdentifierStrategy"
      },
      "overrideParameters": {
        "@id": "urn:undefineds:xpod:MultiDomainIdentifierStrategy"
      }
    },
    {
      "comment": "Auto-detect OIDC Handler - 有 idpUrl 时启用 SP 模式",
      "@id": "urn:undefineds:xpod:AutoDetectOidcHandler",
      "@type": "AutoDetectOidcHandler",
      "options_idpUrl": {
        "@id": "urn:solid-server:default:variable:idpUrl"
      },
      "options_cacheMs": 300000
    },
    {
      "comment": "Override: 使用 AutoDetectOidcHandler 替换默认 OidcHandler",
      "@type": "Override",
      "overrideInstance": {
        "@id": "urn:solid-server:default:OidcHandler"
      },
      "overrideParameters": {
        "@id": "urn:undefineds:xpod:AutoDetectOidcHandler"
      }
    },
    {
      "comment": "Auto-detect Identity Provider Handler",
      "@id": "urn:undefineds:xpod:AutoDetectIdentityProviderHandler",
      "@type": "AutoDetectIdentityProviderHandler",
      "options_idpUrl": {
        "@id": "urn:solid-server:default:variable:idpUrl"
      }
    },
    {
      "comment": "Override: 使用 AutoDetectIdentityProviderHandler 替换默认 Handler",
      "@type": "Override",
      "overrideInstance": {
        "@id": "urn:solid-server:default:IdentityProviderHandler"
      },
      "overrideParameters": {
        "@id": "urn:undefineds:xpod:AutoDetectIdentityProviderHandler"
      }
    },
    {
      "comment": "禁用 Quota",
      "@id": "urn:undefineds:xpod:QuotaService",
      "@type": "NoopQuotaService"
    },
    {
      "@id": "urn:solid-server:default:variable:rootFilePath",
      "@value": "./data"
    },
    {
      "comment": "Shared QuintStore instance",
      "@id": "urn:undefineds:xpod:QuintStore",
      "@type": "SqliteQuintStore",
      "path": {
        "@id": "urn:solid-server:default:variable:sparqlEndpoint",
        "@type": "Variable"
      }
    },
    {
      "comment": "VectorStore using SQLite",
      "@id": "urn:undefineds:xpod:VectorStore",
      "@type": "SqliteVectorStore",
      "options_connectionString": {
        "@id": "urn:solid-server:default:variable:sparqlEndpoint"
      }
    },
    {
      "comment": "Vector HTTP Handler",
      "@id": "urn:undefineds:xpod:VectorHttpHandler",
      "@type": "VectorHttpHandler",
      "vectorStore": { "@id": "urn:undefineds:xpod:VectorStore" },
      "credentialsExtractor": { "@id": "urn:solid-server:default:CredentialsExtractor" },
      "permissionReader": { "@id": "urn:solid-server:default:PermissionReader" },
      "authorizer": { "@id": "urn:solid-server:default:Authorizer" }
    },
    {
      "comment": "DefaultSparqlEngine",
      "@id": "urn:undefineds:xpod:DefaultSparqlEngine",
      "@type": "QuintstoreSparqlEngine",
      "store": { "@id": "urn:undefineds:xpod:QuintStore" }
    },
    {
      "comment": "MixDataAccessor for RDF and binary data",
      "@id": "urn:undefineds:xpod:MixDataAccessor",
      "@type": "MixDataAccessor",
      "structuredDataAccessor": { "@id": "urn:undefineds:xpod:QuintStoreSparqlDataAccessor" },
      "unstructuredDataAccessor": { "@id": "urn:solid-server:default:FileDataAccessor" }
    },
    {
      "comment": "QuintStore-based SPARQL data accessor",
      "@id": "urn:undefineds:xpod:QuintStoreSparqlDataAccessor",
      "@type": "QuintStoreSparqlDataAccessor",
      "store": { "@id": "urn:undefineds:xpod:QuintStore" },
      "identifierStrategy": { "@id": "urn:solid-server:default:IdentifierStrategy" }
    },
    {
      "comment": "SPARQL-capable store for quadstore-backed resources",
      "@id": "urn:undefineds:xpod:SparqlQuadstoreResourceStore",
      "@type": "SparqlUpdateResourceStore",
      "identifierStrategy": { "@id": "urn:solid-server:default:IdentifierStrategy" },
      "auxiliaryStrategy": { "@id": "urn:solid-server:default:AuxiliaryStrategy" },
      "metadataStrategy": { "@id": "urn:solid-server:default:MetadataStrategy" },
      "accessor": { "@id": "urn:undefineds:xpod:MixDataAccessor" }
    },
    {
      "comment": "Override: ResourceStore 使用 QuintStore",
      "@type": "Override",
      "overrideInstance": { "@id": "urn:solid-server:default:ResourceStore_Backend" },
      "overrideParameters": {
        "@type": "SparqlUpdateResourceStore",
        "identifierStrategy": { "@id": "urn:solid-server:default:IdentifierStrategy" },
        "auxiliaryStrategy": { "@id": "urn:solid-server:default:AuxiliaryStrategy" },
        "metadataStrategy": { "@id": "urn:solid-server:default:MetadataStrategy" },
        "accessor": { "@id": "urn:undefineds:xpod:MixDataAccessor" }
      }
    },
    {
      "comment": "Override: Converting store 只转换 RDF 类型",
      "@type": "Override",
      "overrideInstance": { "@id": "urn:solid-server:default:ResourceStore_Converting" },
      "overrideParameters": {
        "@type": "RepresentationPartialConvertingStore",
        "source": { "@id": "urn:solid-server:default:ResourceStore_Backend" },
        "metadataStrategy": { "@id": "urn:solid-server:default:MetadataStrategy" },
        "options_inConverter": { "@id": "urn:solid-server:default:RepresentationConverter" },
        "options_outConverter": { "@id": "urn:solid-server:default:RepresentationConverter" },
        "options_inPreferences_type": {
          "RepresentationPartialConvertingStore:_options_inPreferences_type_key": "internal/quads",
          "RepresentationPartialConvertingStore:_options_inPreferences_type_value": 1
        }
      }
    },
    {
      "comment": "Override: 使用内存锁",
      "@type": "Override",
      "overrideInstance": { "@id": "urn:solid-server:default:ResourceLocker" },
      "overrideParameters": {
        "@type": "WrappedExpiringReadWriteLocker",
        "locker": {
          "@type": "GreedyReadWriteLocker",
          "locker": { "@type": "MemoryResourceLocker" },
          "storage": { "@type": "MemoryMapStorage" }
        },
        "expiration": 6000
      }
    },
    {
      "comment": "Override: 使用 SQLite KeyValueStorage",
      "@type": "Override",
      "overrideInstance": { "@id": "urn:solid-server:default:KeyValueStorage" },
      "overrideParameters": {
        "@type": "SqliteKeyValueStorage",
        "path": { "@id": "urn:solid-server:default:variable:identityDbUrl" }
      }
    },
    {
      "comment": "注册开关 - Cloud 模式启用，SP 模式禁用",
      "@id": "urn:solid-server:default:variable:registration",
      "@type": "Variable"
    },
    {
      "comment": "HTTP Pipeline",
      "@type": "Override",
      "overrideInstance": { "@id": "urn:solid-server:default:BaseHttpHandler" },
      "overrideParameters": {
        "@type": "StatusWaterfallHandler",
        "handlers": [
          { "@id": "urn:undefineds:xpod:SubgraphSparqlHttpHandler" },
          { "@id": "urn:undefineds:xpod:VectorHttpHandler" },
          { "@id": "urn:undefineds:xpod:TerminalHttpHandler" },
          { "@id": "urn:undefineds:xpod:AppStaticAssetHandler" },
          { "@id": "urn:solid-server:default:StaticAssetHandler" },
          { "@id": "urn:solid-server:default:OidcHandler" },
          { "@id": "urn:solid-server:default:NotificationHttpHandler" },
          { "@id": "urn:solid-server:default:StorageDescriptionHandler" },
          { "@id": "urn:solid-server:default:AuthResourceHttpHandler" },
          { "@id": "urn:solid-server:default:IdentityProviderHandler" },
          { "@id": "urn:solid-server:default:LdpHandler" }
        ]
      }
    }
  ]
}
