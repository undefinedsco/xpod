# xpod 多端架构分析

> 分析 Web 端、桌面端、移动端 (linx) 的差异、公共部分和独特部分

---

## 一、部署模式与端的对应关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         部署模式与端的对应关系                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   后端模式              主要客户端              场景                          │
│   ────────────────────────────────────────────────────────────────────      │
│   server/cluster:center  → Web 端              云端托管、多用户           │
│   local/cluster:edge     → 桌面端 (Electron)   本地部署、边缘节点         │
│   任意                   → 移动端/linx         应用层、AI 对话            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、功能矩阵

| 功能 | Web 端 | 桌面端 | linx 端 | 说明 |
|------|---------|---------|---------|------|
| **【Account 级】** | | | | |
| 登录/注册 | ✓ | ✓ | ✓ | 公共 |
| Pods 列表/管理 | ✓ | ✓ | ○ | linx 简化版 |
| Nodes 列表/管理 | ✓ | ✓ | ✗ | 管理向 |
| 存储/配额总览 | ✓ | ✓ | ○ | linx 简化版 |
| 账单/套餐 | ✓ | ✗ | ✗ | Center 专属 |
| **【Pod 级 - 管理】** | | | | |
| Pod Settings | ✓ | ✓ | ✓ | 公共 |
|  ├─ 密钥管理 | ✓ | ✓ | ✓ | |
|  ├─ 偏好设置 | ✓ | ✓ | ✓ | |
|  ├─ Profile/WebID | ✓ | ✓ | ✓ | |
|  ├─ 权限/ACL | ✓ | ✓ | ○ | linx 简化版 |
|  └─ 导入/导出 | ✓ | ✓ | ✗ | 管理向 |
| **【Pod 级 - 应用】** | | | | |
| AI 对话 (ChatKit) | ○ | ○ | ✓ | linx 主场 |
| 文件管理 | ✗ | ✗ | ✓ | linx 专属 |
| Memory/RAG | ✗ | ✗ | ✓ | linx 专属 |
| **【服务级 - Edge 专属】** | | | | |
| 启动/停止 CSS | ✗ | ✓ | ✗ | 桌面端专属 |
| Edge 配置 | ✗ | ✓ | ✗ | |
|  ├─ Signal Endpoint | ✗ | ✓ | ✗ | |
|  ├─ FRP 隧道 | ✗ | ✓ | ✗ | |
|  └─ ACME 证书 | ✗ | ✓ | ✗ | |
| Ollama 管理 | ✗ | ✓ | ✗ | 桌面端专属 |
| 日志查看 | ○ | ✓ | ✗ | Web 只读远程 |
| 终端 | ○ | ✓ | ✗ | Web 受限 |
| 系统托盘 | ✗ | ✓ | ✗ | 桌面端专属 |

**图例**: ✓ 完整支持  ○ 部分支持/可选  ✗ 不支持

---

## 三、公共部分 (所有端共享)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              公共部分                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 设计系统                                                                │
│     ├─ 设计 Token (颜色、字体、间距、圆角)                                   │
│     ├─ 基础 UI 组件 (Button, Card, Input, Modal, Form...)                 │
│     └─ 图标库 (Lucide)                                                      │
│                                                                             │
│  2. 认证模块                                                                │
│     ├─ 登录/注册流程                                                        │
│     ├─ OIDC 授权页                                                         │
│     ├─ AuthContext / Session 管理                                          │
│     └─ API 请求鉴权封装                                                      │
│                                                                             │
│  3. Pod Settings 组件                                                       │
│     ├─ 密钥管理 (供应商 Key, AI API Key)                                    │
│     ├─ 偏好设置 (默认模型, 路由规则)                                        │
│     └─ Profile 编辑 (WebID 信息)                                            │
│                                                                             │
│  4. API 客户端                                                              │
│     ├─ 类型定义 (Pod, Node, Credential, Quota...)                          │
│     ├─ 请求封装 (fetch + credentials)                                       │
│     └─ 错误处理                                                             │
│                                                                             │
│  5. 工具函数                                                                │
│     ├─ 格式化 (日期、字节、时长)                                             │
│     ├─ 验证 (URL, Email)                                                    │
│     └─ 存储 (localStorage 封装)                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、Web 端独特部分 (server/center)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Web 端独特部分 (server/center)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 多用户/多租户视角                                                        │
│     ├─ 账单/套餐管理 (官方托管版)                                            │
│     └─ 用量统计/配额展示                                                     │
│                                                                             │
│  2. 节点管理 (Center 视角)                                                  │
│     ├─ 边缘节点列表 (我注册的所有节点)                                      │
│     ├─ 节点状态监控 (在线/离线/降级)                                        │
│     ├─ 连接模式 (direct/proxy)                                             │
│     └─ Pod 迁移 (云 ↔ 边缘)                                                 │
│                                                                             │
│  3. 远程日志/终端 (受限)                                                     │
│     ├─ 通过 API 查看节点日志                                                │
│     └─ 通过 WebSocket 远程终端 (需权限)                                     │
│                                                                             │
│  4. 部署方式                                                                │
│     └─ 静态文件 (构建到 static/app, CSS 托管)                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、桌面端独特部分 (local/edge)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         桌面端独特部分 (local/edge)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 服务生命周期管理                                                         │
│     ├─ CSS 进程控制 (启动/停止/重启)                                         │
│     ├─ Ollama 进程控制                                                      │
│     ├─ frpc 进程控制                                                         │
│     └─ 运行状态监控                                                           │
│                                                                             │
│  2. Edge 节点配置                                                           │
│     ├─ Signal Endpoint 配置                                                │
│     ├─ nodeId / nodeToken 管理                                             │
│     ├─ FRP 隧道配置 (server/port/token)                                    │
│     ├─ ACME 证书配置 (域名/邮箱/路径)                                       │
│     └─ DNS 提供商配置                                                       │
│                                                                             │
│  3. 本地资源管理                                                             │
│     ├─ 数据目录选择                                                         │
│     ├─ 端口配置                                                             │
│     ├─ 本地模型管理 (Ollama 模型列表)                                       │
│     └─ 本地存储统计                                                         │
│                                                                             │
│  4. 系统集成                                                               │
│     ├─ 系统托盘 (常驻/快捷操作)                                             │
│     ├─ 开机自启                                                             │
│     ├─ 自动更新                                                             │
│     └─ 本地日志文件管理                                                     │
│                                                                             │
│  5. 日志/终端 (完整)                                                        │
│     ├─ 实时日志流 (CSS/Ollama/frpc)                                        │
│     ├─ 日志等级筛选                                                         │
│     ├─ 日志搜索/导出                                                        │
│     └─ 本地终端 (完整 shell)                                                │
│                                                                             │
│  6. Electron 特有                                                          │
│     ├─ 主进程 (Node.js 环境)                                               │
│     ├─ IPC 通信                                                            │
│     ├─ 原生菜单                                                            │
│     └─ 文件系统访问                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、linx 端独特部分 (应用层)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          linx 端独特部分 (应用层)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. AI 对话功能                                                             │
│     ├─ ChatKit UI (对话界面)                                               │
│     ├─ 对话历史管理                                                         │
│     ├─ 模型选择器                                                           │
│     ├─ 上下文/附件                                                          │
│     └─ 工具调用展示                                                         │
│                                                                             │
│  2. 文件管理                                                               │
│     ├─ Pod 内文件浏览                                                      │
│     ├─ 上传/下载                                                           │
│     ├─ 文件预览                                                             │
│     └─ 分享/权限                                                            │
│                                                                             │
│  3. Memory/RAG                                                             │
│     ├─ 长期记忆管理                                                         │
│     ├─ 知识库管理                                                           │
│     └─ 向量索引状态                                                         │
│                                                                             │
│  4. 轻量化特点                                                             │
│     ├─ 单 Pod 视角 (不关心 Account 管理)                                   │
│     ├─ 应用优先 (使用 > 管理)                                              │
│     └─ 移动端适配                                                           │
│                                                                             │
│  5. 多形态                                                                 │
│     ├─ Web 版 (PWA 可选)                                                   │
│     ├─ 移动端 (React Native / Capacitor)                                  │
│     └─ 桌面端 (Electron，可内嵌于 xpod 桌面端)                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、代码复用策略 (Monorepo + 共享包)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              代码复用策略                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  方案: Monorepo + 共享包                                                    │
│                                                                             │
│  xpod/                                                                      │
│  ├── packages/                    # 共享包                                  │
│  │   ├── ui/                      # @xpod/ui - 基础组件                     │
│  │   │   ├─ Button, Card, Input, Modal, Form, Table...                   │
│  │   │   └─ 无业务逻辑，纯 UI                                                  │
│  │   │                                                                     │
│  │   ├── shared/                  # @xpod/shared - 业务组件                   │
│  │   │   ├─ AuthProvider, ProtectedRoute                                  │
│  │   │   ├─ PodSettings (密钥/偏好/Profile)                               │
│  │   │   ├─ PodCard, NodeStatus                                           │
│  │   │   └─ 可在 Web/桌面/linx 复用                                       │
│  │   │                                                                     │
│  │   ├── api/                     # @xpod/api - API 客户端                    │
│  │   │   ├─ 类型定义                                                        │
│  │   │   ├─ 请求封装                                                        │
│  │   │   └─ React hooks (usePods, useNodes...)                             │
│  │   │                                                                     │
│  │   └── tokens/                  # @xpod/tokens - 设计 Token                  │
│  │       ├─ CSS 变量                                                        │
│  │       └─ Tailwind 配置                                                    │
│  │                                                                            │
│  ├── apps/                                                                     │
│  │   ├── web/                     # Web 端 (原 ui/)                          │
│  │   │   ├─ 引用 @xpod/* 包                                                 │
│  │   │   └─ Web 独特页面 (Nodes, Billing...)                                │
│  │   │                                                                     │
│  │   ├── desktop/                 # 桌面端                                   │
│  │   │   ├─ 引用 @xpod/* 包                                                 │
│  │   │   ├─ Electron 主进程                                                 │
│  │   │   └─ 桌面独特页面 (Status, Config, Logs...)                          │
│  │   │                                                                     │
│  │   └── linx/                    # linx 端 (可独立仓库)                     │
│  │       ├─ 引用 @xpod/* 包                                                 │
│  │       └─ linx 独特页面 (Chat, Files, Memory...)                          │
│  │                                                                            │
│  └── src/                         # 后端 (保持不变)                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、核心差异总结

| 维度 | Web 端 (server/center) | 桌面端 (local/edge) | linx 端 |
|------|-------------------------|---------------------|---------|
| **定位** | 管理端，多用户 | 管理端，服务级 | 应用端，Pod 级 |
| **主要用户** | 平台管理员、普通用户 | 自部署用户、边缘节点拥有者 | AI 应用用户 |
| **核心功能** | Pods/Nodes 管理、账单 | CSS/Ollama 进程管理、Edge 配置 | AI 对话、文件、Memory |
| **部署方式** | 静态文件 + CSS | Electron 应用 | Web/PWA/移动端 |
| **数据访问** | HTTP + OIDC | Unix Socket + IPC | HTTP + OIDC |
| **离线能力** | 无 | 完全离线 | 部分离线 |
| **特殊能力** | 多租户、Pod 迁移 | 进程管理、系统托盘 | ChatKit、文件浏览 |

---

## 九、下一步规划

基于以上分析，可以继续以下设计：

1. **详细架构设计** (`docs/client-architecture.md`)
   - 目录结构
   - 技术选型
   - API 层设计
   - 状态管理

2. **桌面端详细设计**
   - Electron 主进程架构
   - 进程管理器
   - IPC 通信

3. **共享包抽取计划**
   - 优先级排序
   - 迁移路径
   - 版本管理

4. **linx 端设计**
   - ChatKit 集成
   - 移动端适配

需要我继续哪个部分？
